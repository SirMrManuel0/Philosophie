<!DOCTYPE html>


<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="/static/css/origin.css">

        <style>
            * {
                padding: 0;
                margin: 0;
                box-sizing: border-box;
            }
            h1, h2, p {
                font-family: "Goudy";
                color: var(--text-color);
            }
            body {
                width: 100vw;
                height: 100vh;
                background-image: url("/static/img/background.jpg");
                background-size: cover;
                overflow: hidden;
            }
            body::-webkit-scrollbar {
                display: none;
            }
            .titleDiv {
                width: 100%;
                height: 15%;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .title {
                color: var(--text-color);
            }
            .chooseDiv {
                width: 100%;
                height: 85%;
                display: flex;
                padding: 30px;
                padding-top: 0px;
                overflow-x: scroll;
                gap: 10px;  
            }
            .land {
                width: 300px;
                height: 100%;
                border: 1px solid #fff;
                flex-shrink: 0;
                background-color: rgba(var(--secondary-colorT), var(--transparency));
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                overflow-y: scroll;
                box-shadow: 0px 0px 20px #000;
                border-radius: 4px;
            }
            .land::-webkit-scrollbar {
                display: none;
            }
            h2 {
                color: var(--text-color);
                margin-top: 20px;
            }
            img {
                width: 100%;
                height: 200px;
                filter: brightness(0.4);
            }
            form input[type='submit'] {
                padding: 8px 16px;
                background-color: var(--background-color);
                border: 1px solid #000;
                color: #fff;
                border-radius: 2px;
                cursor: pointer;
                box-shadow: 0px 0px 4px #000;
            }
            form :nth-child(1) {
                display: block;
            }
            form :nth-child(2) {
                display: none;
                background-color: var(--secondary-color) !important;
            }
            
            .chosen form :nth-child(1) {
                display: none;
            }
            .chosen form :nth-child(2) {
                display: block;
            }
            .chosen img {
                filter: brightness(1);
            }
            .chosen h2 {
                text-decoration: underline;
            }
            .ubersicht {
                width: 100%;
            }

            .team {
                display: flex;
                justify-content: space-between;
                border-bottom: 1px solid #000;
                padding: 10px 20px;
            }
            .-b {
                font-weight: bold;
                border-bottom: 2px solid #000;
            }
            #username {
                position: absolute;
                top: 30px;
                left: 30px;
            }
            #teamname {
                position: absolute;
                top: 50px;
                left: 30px;
                font-size: small;
            }
        </style>
    </head>
    <body>  
        <p id="username">Username</p>
        <p id="teamname">Teamname</p>

        <div class="titleDiv">
            <h1 class="title">Wähle ein Land aus</h1>
        </div>

        <div class="chooseDiv">
            <div class="land" id="Deutschland">
                <h2>Deutschland</h2>
                <img src="/static/img/countries/ger.png" alt="">
                <form class="" action="/select_country" method="post">
                    <input type="submit" value="Auswählen">
                    <input type="submit" value="Ausgewählt">
                    <input type="hidden" value="Deutschland" name="country">
                </form>

                <div class="ubersicht">
                    <div class="team -b">
                        <p>Teamname</p>
                        <p>Stimmen</p>
                    </div>
                    <div class="team">
                        <p>Team1</p>
                        <p>10</p>
                    </div>
                    <div class="team">
                        <p>Team2</p>
                        <p>4</p>
                    </div>
                </div>
            </div>

            <div class="land" id="China">
                <h2>China</h2>
                <img src="/static/img/countries/ch.png" alt="">
                <form class="" action="/select_country" method="post">
                    <input type="submit" value="Auswählen">
                    <input type="submit" value="Ausgewählt">
                    <input type="hidden" value="China" name="country">
                </form>

                <div class="ubersicht">
                    <div class="team -b">   
                        <p>Teamname</p>
                        <p>Stimmen</p>
                    </div>
                    <div class="team">
                        <p>Team1</p>
                        <p>10</p>
                    </div>
                    <div class="team">
                        <p>Team2</p>
                        <p>4</p>
                    </div>
                </div>  
            </div>

            <div class="land" id="Frankreich">
                <h2>Frankreich</h2>
                <img src="/static/img/countries/fra.png" alt="">
                <form class="" action="/select_country" method="post">

                    <input type="submit" value="Auswählen">
                    <input type="submit" value="Ausgewählt">
                    <input type="hidden" value="Frankreich" name="country">
                </form>

                <div class="ubersicht">
                    <div class="team -b">
                        <p>Teamname</p>
                        <p>Stimmen</p>
                    </div>
                    <div class="team">
                        <p>Team1</p>
                        <p>10</p>
                    </div>
                    <div class="team">
                        <p>Team2</p>
                        <p>4</p>
                    </div>
                </div>
            </div>

            <div class="land" id="Schweiz">
                <h2>Schweiz</h2>
                <img src="/static/img/countries/schw.png" alt="">
                <form class="" action="/select_country" method="post">
                    <input type="submit" value="Auswählen">
                    <input type="submit" value="Ausgewählt">
                    <input type="hidden" value="Schweiz" name="country">
                </form>

                <div class="ubersicht">
                    <div class="team -b">
                        <p>Teamname</p>
                        <p>Stimmen</p>
                    </div>
                    <div class="team">
                        <p>Team1</p>
                        <p>10</p>
                    </div>
                    <div class="team">
                        <p>Team2</p>
                        <p>4</p>
                    </div>
                </div>
            </div>


            <div class="land" id="Russland">
                <h2>Russland</h2>
                <img src="/static/img/countries/rus.png" alt="">
                <form class="" action="/select_country" method="post">
                    <input type="submit" value="Auswählen">
                    <input type="submit" value="Ausgewählt">
                    <input type="hidden" value="Russland" name="country">
                </form>

                <div class="ubersicht">
                    <div class="team -b">
                        <p>Teamname</p>
                        <p>Stimmen</p>
                    </div>
                    <div class="team">
                        <p>Team1</p>
                        <p>10</p>
                    </div>
                    <div class="team">
                        <p>Team2</p>
                        <p>4</p>
                    </div>
                </div>
            </div>

            
            <div class="land" id="Botswana">
                <h2>Botswana</h2>
                <img src="/static/img/countries/bot.png" alt="">
                <form class="" action="/select_country" method="post">
                    <input type="submit" value="Auswählen">
                    <input type="submit" value="Ausgewählt">
                    <input type="hidden" value="Botswana" name="country">
                </form>

                <div class="ubersicht">
                    <div class="team -b">
                        <p>Teamname</p>
                        <p>Stimmen</p>
                    </div>
                    <div class="team">
                        <p>Team1</p>
                        <p>10</p>
                    </div>
                    <div class="team">
                        <p>Team2</p>
                        <p>4</p>
                    </div>
                </div>
            </div>
        </div>
        <script>
            const url = "http://ADDRESS/api";

            async function sendPostRequest(data) {
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json", // JSON-Format angeben
                        },
                        body: JSON.stringify(data), // Daten in JSON umwandeln
                    });

                    if (response.ok) {
                        const responseText = await response.text(); // Antwort des Servers
                        const responseDict = JSON.parse(responseText); // JSON-String in Objekt umwandeln
                        return responseDict;
                    } else {
                        console.error("Fehler beim Request:", response.statusText);
                    }
                } catch (error) {
                    console.error("Netzwerkfehler:", error);
                }
            }

            async function getUsername() {
                try {
                    const responseDict = await sendPostRequest({ message: "username" });
                    return responseDict["username"];
                } catch (error) {
                    console.error("Fehler beim Abrufen des Benutzernamens:", error);
                    return null;
                }
            }

            async function updateUsername() {
                const username = await getUsername();
                if (username) {
                    setUsername(username); // Setze den Benutzernamen im HTML
                } else {
                    console.error("Benutzername konnte nicht abgerufen werden.");
                }
            }

            async function getTeamname() {
                try {
                    const responseDict = await sendPostRequest({ message: "teamname" });
                    return responseDict["teamname"];
                } catch (error) {
                    console.error("Fehler beim Abrufen des Teamnames:", error);
                    return null;
                }
            }

            async function updateTeamname() {
                const teamname = await getTeamname();
                if (teamname) {
                    setTeamname(teamname); // Setze den Benutzernamen im HTML
                } else {
                    console.error("Teamname konnte nicht abgerufen werden.");
                }
            }

            function setUsername(username) {
                // Set the username
                document.getElementById('username').textContent = username;
            }

            function setTeamname(teamname) {
                // Set the username
                document.getElementById('teamname').textContent = teamname;
            }

            async function getCountry() {
                try {
                    const responseDict = await sendPostRequest({ message: "user_country" });
                    return responseDict["user_country"];
                } catch (error) {
                    console.error("Fehler beim Abrufen des user_country:", error);
                    return null;
                }
            }
            async function updateCountry() {
                const country = await getCountry();
                if (country) {
                    setCountry(country); // Setze den Benutzernamen im HTML
                } else {
                    console.error("Benutzername konnte nicht abgerufen werden.");
                }
            }
            function setCountry(country) {
                document.getElementById(country).classList.add("chosen");
            }

            async function getTeamvotes() {
                try {
                    const responseDict = await sendPostRequest({ message: "team_votes" });
                    return responseDict["team_votes"];
                } catch (error) {
                    console.error("Fehler beim Abrufen des team_votes:", error);
                    return null;
                }
            }

            async function updateTeamnamevotes() {
                const teamVotes = await getTeamvotes();
                if (teamVotes) {
                    deleteTeamvotes();
                    createTeamvotes(teamVotes);
                } else {
                    console.error("TeamVotes konnten nicht abgerufen werden.");
                }
            }

            function deleteTeamvotes() {
                // Entfernt alle bestehenden Teamstimmen aus allen Ländern
                const lands = document.querySelectorAll(".land .ubersicht");
                lands.forEach((land) => {
                    const teams = land.querySelectorAll(".team");
                    teams.forEach((team, index) => {
                        // Überspringt die Kopfzeile (erste Zeile) mit `Teamname` und `Stimmen`
                        if (index > 0) {
                            team.remove();
                        }
                    });
                });
            }

            
            function createTeamvotes(teamVotes) {
                const userTeam = document.getElementById("teamname").textContent; // Benutzer-Teamname
                console.log(teamVotes)
                for (const country in teamVotes) {
                    const land = document.getElementById(country);
                    if (!land) continue;
  
                    const ubersicht = land.querySelector(".ubersicht");

                    const teams = Object.entries(teamVotes[country]); // [{Team: Stimmen}, ...]

                    // Sortiere die Teams, damit das Benutzerteam zuerst kommt
                    teams.sort(([teamA], [teamB]) => {
                        if (teamA === userTeam) return -1; // Benutzerteam kommt zuerst
                        if (teamB === userTeam) return 1;
                        return 0; // Keine Veränderung bei anderen Teams
                    });

                    teams.forEach(([teamName, votes]) => {
                        const teamDiv = document.createElement("div");
                        teamDiv.className = "team";
                        if (teamName === userTeam) {
                            teamDiv.classList.add("-b"); // Benutzerteam erhält Klasse `-b`
                        }

                        const teamNameEl = document.createElement("p");
                        teamNameEl.textContent = teamName;

                        const votesEl = document.createElement("p");
                        votesEl.textContent = votes;

                        teamDiv.appendChild(teamNameEl);
                        teamDiv.appendChild(votesEl);

                        ubersicht.appendChild(teamDiv);
                    });
                }
            }


            updateCountry();
            updateUsername();
            updateTeamname();
            updateTeamnamevotes();

            setInterval(updateTeamnamevotes, 2000);

        </script>
    </body>
</html>